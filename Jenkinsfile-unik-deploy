pipeline {
    agent any
    parameters {
        string(name: 'instances', defaultValue: '1', description: 'How many instances?')
    }
    stages {
        stage('Pull') {
            steps {
                unik pull(imageName: 'messages-service-rump', provider: 'virtualbox', unikHubEndpoint: hub(credentialsId: 'unik-hub'))
            }
        }
        stage('Deploy') {
            steps {
                script{
                    for(i = 0; i < ${params.instances}; i++) {
                        unik run(imageName: 'message-service-rump', instanceName: 'message-service', envs: "STORAGE_ADDRESS=$STORAGE_ADDRESS LOAD_BALANCER=$LOAD_BALANCER PORT=700${i}")
                    }
                }
            }            
        }
    }
}